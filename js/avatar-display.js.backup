/**
 * Module de gestion de l'affichage de l'avatar
 * Ce module s'occupe de cr√©er et mettre √† jour la section avatar
 */

window.avatarDisplay = (function() {
    'use strict';
    
    /**
     * Cr√©e dynamiquement la section avatar si elle n'existe pas
     */
    function createAvatarSection() {
        console.log('[Avatar Display] Cr√©ation dynamique de la section avatar');
        
        // Trouver le conteneur avatar-section
        const avatarContainer = document.getElementById('avatarSection');
        if (!avatarContainer) {
            console.error('[Avatar Display] Conteneur avatar (avatarSection) introuvable');
            return;
        }
        
        // V√©rifier si la section avatar existe d√©j√†
        if (document.getElementById('avatarProfileSection')) {
            console.log('[Avatar Display] Section avatar d√©j√† existante');
            return;
        }
        
        // Cr√©er la structure HTML compl√®te de la section avatar
        const avatarSection = document.createElement('div');
        avatarSection.id = 'avatarProfileSection';
        avatarSection.className = 'avatar-profile-section';
        avatarSection.style.display = 'block';
        avatarSection.style.marginBottom = '0px';
        avatarSection.style.marginTop = '0px';
        avatarSection.style.border = '2px solid var(--primary-color)';
        avatarSection.style.borderRadius = 'var(--border-radius)';
        avatarSection.style.backgroundColor = 'var(--dark-surface-2)';
        avatarSection.style.padding = '20px';
        avatarSection.style.boxShadow = 'var(--card-shadow)';
        avatarSection.style.width = '100%';
        avatarSection.style.maxWidth = '100%';
        avatarSection.style.boxSizing = 'border-box';
        
        // Utiliser innerHTML pour d√©finir toute la structure HTML fournie
        avatarSection.innerHTML = `
            <div class="avatar-profile-card">
                <div class="avatar-profile-header">
                    <h2><i class="fas fa-user-circle"></i> Profil de l'Acheteur Cible</h2>
                </div>
                
                <!-- Onglets Avatar -->
                <div class="avatar-tabs">
                    <button class="avatar-tab-btn active" data-tab="avatar-profile-tab">
                        <i class="fas fa-user"></i> Profil
                    </button>
                    <button class="avatar-tab-btn" data-tab="avatar-analysis-tab">
                        <i class="fas fa-brain"></i> Analyse Psychologique
                    </button>
                    <button class="avatar-tab-btn" data-tab="avatar-strategy-tab">
                        <i class="fas fa-chess"></i> Strat√©gie
                    </button>
                </div>
                
                <!-- Contenu des onglets -->
                <div class="avatar-tab-content">
                    <!-- Onglet Profil -->
                    <div id="avatar-profile-tab" class="avatar-tab-pane active">
                        <div class="avatar-profile-content">
                            <div class="avatar-profile-grid">
                                <!-- √Çge -->
                                <div class="avatar-profile-item">
                                    <div class="avatar-profile-icon age-icon">
                                        <i class="fas fa-birthday-cake"></i>
                                    </div>
                                    <div class="avatar-profile-data">
                                        <div class="avatar-profile-label">√Çge</div>
                                        <div class="avatar-profile-value" id="avatarAge"></div>
                                    </div>
                                </div>
                                
                                <!-- Sexe -->
                                <div class="avatar-profile-item">
                                    <div class="avatar-profile-icon gender-icon">
                                        <i class="fas fa-venus-mars"></i>
                                    </div>
                                    <div class="avatar-profile-data">
                                        <div class="avatar-profile-label">Sexe</div>
                                        <div class="avatar-profile-value" id="avatarGender"></div>
                                    </div>
                                </div>
                                
                                <!-- Situation familiale -->
                                <div class="avatar-profile-item">
                                    <div class="avatar-profile-icon family-icon">
                                        <i class="fas fa-home"></i>
                                    </div>
                                    <div class="avatar-profile-data">
                                        <div class="avatar-profile-label">Famille</div>
                                        <div class="avatar-profile-value" id="avatarFamily"></div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="avatar-profile-bottom">
                                <div class="avatar-fears-container">
                                    <h3><i class="fas fa-exclamation-triangle"></i> Peurs avant l'achat</h3>
                                    <div class="avatar-fears-list" id="avatarFears">
                                    </div>
                                </div>
                                
                                <div class="avatar-expectations-container">
                                    <h3><i class="fas fa-star"></i> Attentes du produit</h3>
                                    <div class="avatar-expectations-list" id="avatarExpectations">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Onglet Analyse Psychologique -->
                    <div id="avatar-analysis-tab" class="avatar-tab-pane">
                        <div class="psychological-analysis-content">
                            <!-- Section principale du profil psychographique -->
                            <div class="psycho-section-main">
                                <h3><i class="fas fa-brain"></i> Profil Psychographique</h3>
                                <div class="psycho-main-content" id="psychographicMainProfile">
                                    <!-- Le contenu principal sera ins√©r√© ici -->
                                </div>
                            </div>
                            
                            <!-- Grille des sections psychologiques -->
                            <div class="psycho-sections-grid">
                                <!-- √âmotions √† √©voquer -->
                                <div class="psycho-section-card">
                                    <div class="psycho-section-header">
                                        <i class="fas fa-heart"></i>
                                        <h4>√âmotions √† √âvoquer</h4>
                                    </div>
                                    <div class="psycho-section-content" id="emotionsToEvoke">
                                        <!-- Contenu des √©motions -->
                                    </div>
                                </div>
                                
                                <!-- Choix de style de vie -->
                                <div class="psycho-section-card">
                                    <div class="psycho-section-header">
                                        <i class="fas fa-home"></i>
                                        <h4>Style de Vie</h4>
                                    </div>
                                    <div class="psycho-section-content" id="lifestyleChoices">
                                        <!-- Contenu du style de vie -->
                                    </div>
                                </div>
                                
                                <!-- Logique de d√©cision d'achat -->
                                <div class="psycho-section-card">
                                    <div class="psycho-section-header">
                                        <i class="fas fa-lightbulb"></i>
                                        <h4>Logique de D√©cision</h4>
                                    </div>
                                    <div class="psycho-section-content" id="decisionLogic">
                                        <!-- Contenu de la logique de d√©cision -->
                                    </div>
                                </div>
                                
                                <!-- D√©sir principal -->
                                <div class="psycho-section-card">
                                    <div class="psycho-section-header">
                                        <i class="fas fa-bullseye"></i>
                                        <h4>D√©sir Principal</h4>
                                    </div>
                                    <div class="psycho-section-content" id="mainDesire">
                                        <!-- Contenu du d√©sir principal -->
                                    </div>
                                </div>
                                
                                <!-- Probl√®mes √† r√©soudre -->
                                <div class="psycho-section-card">
                                    <div class="psycho-section-header">
                                        <i class="fas fa-wrench"></i>
                                        <h4>Probl√®mes √† R√©soudre</h4>
                                    </div>
                                    <div class="psycho-section-content" id="problemsToSolve">
                                        <!-- Contenu des probl√®mes -->
                                    </div>
                                </div>
                                
                                <!-- Raisons biologiques -->
                                <div class="psycho-section-card">
                                    <div class="psycho-section-header">
                                        <i class="fas fa-dna"></i>
                                        <h4>Raisons Biologiques</h4>
                                    </div>
                                    <div class="psycho-section-content" id="biologicalReasons">
                                        <!-- Contenu des raisons biologiques -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Onglet Strat√©gie -->
                    <div id="avatar-strategy-tab" class="avatar-tab-pane">
                        <div class="strategy-content">
                            <!-- Section principale de la strat√©gie -->
                            <div class="strategy-section-main">
                                <h3><i class="fas fa-chess"></i> Strat√©gie Marketing</h3>
                                <div class="strategy-main-content" id="strategyMainContent">
                                    <!-- Le contenu principal de la strat√©gie sera ins√©r√© ici -->
                                </div>
                            </div>
                            
                            <!-- Grille des sections strat√©giques -->
                            <div class="strategy-sections-grid">
                                <!-- √âmotions Cl√©s √† Susciter -->
                                <div class="strategy-section-card">
                                    <div class="strategy-section-header">
                                        <i class="fas fa-heart"></i>
                                        <h4>√âmotions Cl√©s √† Susciter</h4>
                                    </div>
                                    <div class="strategy-section-content" id="keyEmotions">
                                        <!-- Contenu des √©motions cl√©s -->
                                    </div>
                                </div>
                                
                                <!-- Motivations d'Achat Principales -->
                                <div class="strategy-section-card">
                                    <div class="strategy-section-header">
                                        <i class="fas fa-shopping-cart"></i>
                                        <h4>Motivations d'Achat Principales</h4>
                                    </div>
                                    <div class="strategy-section-content" id="purchaseMotivations">
                                        <!-- Contenu des motivations d'achat -->
                                    </div>
                                </div>
                                
                                
                                <!-- Drivers Biologiques Majeurs -->
                                <div class="strategy-section-card">
                                    <div class="strategy-section-header">
                                        <i class="fas fa-dna"></i>
                                        <h4>Drivers Biologiques Majeurs</h4>
                                    </div>
                                    <div class="strategy-section-content" id="biologicalDrivers">
                                        <!-- Contenu des drivers biologiques -->
                                    </div>
                                </div>
                                
                                <!-- Angles Marketing Cl√©s -->
                                <div class="strategy-section-card">
                                    <div class="strategy-section-header">
                                        <i class="fas fa-angle-double-right"></i>
                                        <h4>Angles Marketing Cl√©s</h4>
                                    </div>
                                    <div class="strategy-section-content" id="marketingAngles">
                                        <!-- Contenu des angles marketing -->
                                    </div>
                                </div>
                                
                                <!-- Messages Marketing √† Valeur Ajout√©e -->
                                <div class="strategy-section-card">
                                    <div class="strategy-section-header">
                                        <i class="fas fa-plus-circle"></i>
                                        <h4>Messages Marketing √† Valeur Ajout√©e</h4>
                                    </div>
                                    <div class="strategy-section-content" id="valueAddedMessages">
                                        <!-- Contenu des messages √† valeur ajout√©e -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // Ins√©rer la section avatar dans le conteneur avatar
        avatarContainer.appendChild(avatarSection);
        
        // Initialiser les onglets avatar avec un d√©lai pour s'assurer que le DOM est mis √† jour
        setTimeout(() => {
            initializeAvatarTabs();
        }, 100);
        
        console.log('[Avatar Display] Section avatar cr√©√©e et ins√©r√©e dans avatarSection');
    }
    
    /**
     * Met √† jour le profil avatar avec les donn√©es fournies
     * @param {Object} profile - Donn√©es du profil avatar
     */
    function updateAvatarProfile(profile) {
        if (!profile || typeof profile !== 'object') {
            console.error('[Avatar Display] Profil invalide fourni pour la mise √† jour');
            return;
        }
        
        console.log('[Avatar Display] Mise √† jour du profil avatar avec les donn√©es:', profile);
        
        // Debug: V√©rifier que les √©l√©ments existent dans le DOM
        console.log('[Avatar Display] V√©rification des √©l√©ments DOM:');
        console.log('- avatarAge existe:', !!document.getElementById('avatarAge'));
        console.log('- avatarGender existe:', !!document.getElementById('avatarGender'));
        console.log('- avatarFamily existe:', !!document.getElementById('avatarFamily'));
        
        // Mettre √† jour l'√¢ge
        if (profile.age) {
            console.log('[Avatar Display] Traitement de l\'√¢ge:', profile.age);
            const avatarAge = document.getElementById('avatarAge');
            if (avatarAge) {
                console.log('[Avatar Display] √âl√©ment avatarAge trouv√©, mise √† jour...');
                if (profile.age === "X") {
                    avatarAge.innerHTML = `<span class="age-emoji">‚ùì</span> <span class="age-text">X</span>`;
                    console.log('[Avatar Display] √Çge mis √† jour avec X');
                } else {
                    const ageEmoji = getAgeEmoji(profile.age);
                    console.log('[Avatar Display] Emoji d\'√¢ge calcul√©:', ageEmoji);
                    avatarAge.innerHTML = `<span class="age-emoji">${ageEmoji}</span> <span class="age-text">${profile.age}</span>`;
                    console.log('[Avatar Display] √Çge mis √† jour avec:', profile.age);
                }
            } else {
                console.error('[Avatar Display] √âl√©ment avatarAge non trouv√© dans le DOM');
            }
        } else {
            console.warn('[Avatar Display] Aucun √¢ge fourni dans le profil');
        }
        
        // Mettre √† jour le sexe
        if (profile.gender) {
            console.log('[Avatar Display] Traitement du genre:', profile.gender);
            const avatarGender = document.getElementById('avatarGender');
            if (avatarGender) {
                console.log('[Avatar Display] √âl√©ment avatarGender trouv√©, mise √† jour...');
                if (profile.gender === "X") {
                    avatarGender.innerHTML = `<span class="gender-symbol">‚ùì</span> <span class="gender-text">X</span>`;
                    console.log('[Avatar Display] Genre mis √† jour avec X');
                } else {
                    const genderSymbol = profile.gender === "Homme" ? "‚ôÇÔ∏è" : profile.gender === "Femme" ? "‚ôÄÔ∏è" : "‚ùì";
                    console.log('[Avatar Display] Symbole de genre calcul√©:', genderSymbol);
                    avatarGender.innerHTML = `<span class="gender-symbol">${genderSymbol}</span> <span class="gender-text">${profile.gender}</span>`;
                    console.log('[Avatar Display] Genre mis √† jour avec:', profile.gender);
                }
            } else {
                console.error('[Avatar Display] √âl√©ment avatarGender non trouv√© dans le DOM');
            }
        } else {
            console.warn('[Avatar Display] Aucun genre fourni dans le profil');
        }
        
        // Mettre √† jour la situation familiale
        if (profile.familyStatus) {
            const avatarFamily = document.getElementById('avatarFamily');
            if (avatarFamily) {
                if (profile.familyStatus === "X") {
                    avatarFamily.innerHTML = `<span class="family-emoji">‚ùì</span> <span class="family-text">X</span>`;
                } else {
                    const familyEmoji = getFamilyEmoji(profile.familyStatus);
                    avatarFamily.innerHTML = `<span class="family-emoji">${familyEmoji}</span> <span class="family-text">${profile.familyStatus}</span>`;
                }
            }
        }
        
        // Mettre √† jour les peurs
        if (profile.fears && Array.isArray(profile.fears)) {
            const avatarFears = document.getElementById('avatarFears');
            if (avatarFears) {
                avatarFears.innerHTML = '';
                profile.fears.forEach(fear => {
                    const fearItem = document.createElement('div');
                    fearItem.className = 'fear-item';
                    
                    if (fear === "X") {
                        fearItem.innerHTML = `
                            <div class="fear-icon"><i class="fas fa-question-circle"></i></div>
                            <div class="fear-text">X</div>
                        `;
                    } else {
                        const fearIcon = getFearIcon(fear);
                        fearItem.innerHTML = `
                            <div class="fear-icon"><i class="fas ${fearIcon}"></i></div>
                            <div class="fear-text">${fear}</div>
                        `;
                    }
                    
                    avatarFears.appendChild(fearItem);
                });
            }
        }
        
        // Mettre √† jour les attentes
        if (profile.expectations && Array.isArray(profile.expectations)) {
            const avatarExpectations = document.getElementById('avatarExpectations');
            if (avatarExpectations) {
                avatarExpectations.innerHTML = '';
                profile.expectations.forEach(expectation => {
                    const expectationItem = document.createElement('div');
                    expectationItem.className = 'expectation-item';
                    
                    if (expectation === "X") {
                        expectationItem.innerHTML = `
                            <div class="expectation-icon"><i class="fas fa-question-circle"></i></div>
                            <div class="expectation-text">X</div>
                        `;
                    } else {
                        const expectationIcon = getExpectationIcon(expectation);
                        expectationItem.innerHTML = `
                            <div class="expectation-icon"><i class="fas ${expectationIcon}"></i></div>
                            <div class="expectation-text">${expectation}</div>
                        `;
                    }
                    
                    avatarExpectations.appendChild(expectationItem);
                });
            }
        }
        
        // Mettre √† jour l'analyse psychologique
        if (profile.psychologicalAnalysis) {
            // Parser et organiser l'analyse psychologique
            const parsedAnalysis = parsePsychologicalAnalysis(profile.psychologicalAnalysis);
            
            // Mettre √† jour le profil principal
            const psychographicMainProfile = document.getElementById('psychographicMainProfile');
            if (psychographicMainProfile) {
                psychographicMainProfile.innerHTML = parsedAnalysis.mainProfile || profile.psychologicalAnalysis;
            }
            
            // Mettre √† jour les sections sp√©cifiques
            updatePsychologicalSection('emotionsToEvoke', parsedAnalysis.emotionsToEvoke);
            updatePsychologicalSection('lifestyleChoices', parsedAnalysis.lifestyleChoices);
            updatePsychologicalSection('decisionLogic', parsedAnalysis.decisionLogic);
            updatePsychologicalSection('mainDesire', parsedAnalysis.mainDesire);
            updatePsychologicalSection('problemsToSolve', parsedAnalysis.problemsToSolve);
            updatePsychologicalSection('biologicalReasons', parsedAnalysis.biologicalReasons);
            
            // Fallback : afficher le contenu complet si pas de sections sp√©cifiques
            const avatarPsychologicalAnalysis = document.getElementById('avatarPsychologicalAnalysis');
            if (avatarPsychologicalAnalysis) {
                avatarPsychologicalAnalysis.innerHTML = profile.psychologicalAnalysis;
            }
        }
        
        // Mettre √† jour les sections psychologiques
        if (profile.psychologicalSections) {
            const psychologicalSections = profile.psychologicalSections;
            
            // Profil psychographique
            if (psychologicalSections.mainProfile) {
                const psychographicMainProfile = document.getElementById('psychographicMainProfile');
                if (psychographicMainProfile) {
                    psychographicMainProfile.innerHTML = psychologicalSections.mainProfile;
                }
            }
            
            // √âmotions √† √©voquer
            if (psychologicalSections.emotionsToEvoke) {
                const emotionsToEvoke = document.getElementById('emotionsToEvoke');
                if (emotionsToEvoke) {
                    emotionsToEvoke.innerHTML = psychologicalSections.emotionsToEvoke;
                }
            }
            
            // Choix de style de vie
            if (psychologicalSections.lifestyleChoices) {
                const lifestyleChoices = document.getElementById('lifestyleChoices');
                if (lifestyleChoices) {
                    lifestyleChoices.innerHTML = psychologicalSections.lifestyleChoices;
                }
            }
            
            // Logique de d√©cision d'achat
            if (psychologicalSections.decisionLogic) {
                const decisionLogic = document.getElementById('decisionLogic');
                if (decisionLogic) {
                    decisionLogic.innerHTML = psychologicalSections.decisionLogic;
                }
            }
            
            // D√©sir principal
            if (psychologicalSections.mainDesire) {
                const mainDesire = document.getElementById('mainDesire');
                if (mainDesire) {
                    mainDesire.innerHTML = psychologicalSections.mainDesire;
                }
            }
            
            // Probl√®mes √† r√©soudre
            if (psychologicalSections.problemsToSolve) {
                const problemsToSolve = document.getElementById('problemsToSolve');
                if (problemsToSolve) {
                    problemsToSolve.innerHTML = psychologicalSections.problemsToSolve;
                }
                // Le code concernant la strat√©gie a √©t√© supprim√© car il ne devrait pas √™tre dans cette fonction
            }
            
            // Raisons biologiques
            if (psychologicalSections.biologicalReasons) {
                const biologicalReasons = document.getElementById('biologicalReasons');
                if (biologicalReasons) {
                    biologicalReasons.innerHTML = psychologicalSections.biologicalReasons;
                }
            }
        }
    }
}

/**
 * Met √† jour le contenu de la strat√©gie marketing avec les donn√©es fournies
 * @param {Object|string} strategyData - Donn√©es de la strat√©gie marketing ou contenu texte brut
 */
function updateStrategyContent(strategyData) {
    console.log('[Avatar Display] Mise √† jour du contenu de la strat√©gie marketing');
    
    // Si strategyData est une cha√Æne, traiter comme du contenu brut
    if (typeof strategyData === 'string') {
        console.log('[Avatar Display] Contenu brut d√©tect√©, parsing n√©cessaire');
        
        // Mettre √† jour le contenu principal de la strat√©gie
        const strategyMainContent = document.getElementById('strategyMainContent');
        if (strategyMainContent) {
            strategyMainContent.innerHTML = strategyData;
            console.log('[Avatar Display] Contenu principal mis √† jour avec le texte brut');
        }
        
        // Parser le contenu pour extraire les sections sp√©cifiques
        parseAndUpdateStrategySections(strategyData);
        return;
    }
    
    // Si strategyData est un objet, traiter comme avant
    if (!strategyData || typeof strategyData !== 'object') {
        console.error('[Avatar Display] Donn√©es de strat√©gie invalides fournie pour la mise √† jour');
        return;
    }
    
    // Mettre √† jour le contenu principal de la strat√©gie
    const strategyMainContent = document.getElementById('strategyMainContent');
    if (strategyMainContent && strategyData.mainStrategy) {
        strategyMainContent.innerHTML = strategyData.mainStrategy;
    }
    
    // Mettre √† jour les √©motions cl√©s √† susciter
    const keyEmotions = document.getElementById('keyEmotions');
    if (keyEmotions && strategyData.keyEmotions) {
        if (Array.isArray(strategyData.keyEmotions)) {
            keyEmotions.innerHTML = '<ul>' + 
                strategyData.keyEmotions.map(emotion => `<li>${emotion}</li>`).join('') + 
                '</ul>';
        } else {
            keyEmotions.innerHTML = strategyData.keyEmotions;
        }
    }
    
    // Mettre √† jour les motivations d'achat principales
    const purchaseMotivations = document.getElementById('purchaseMotivations');
    if (purchaseMotivations && strategyData.purchaseMotivations) {
        if (Array.isArray(strategyData.purchaseMotivations)) {
            purchaseMotivations.innerHTML = '<ul>' + 
                strategyData.purchaseMotivations.map(motivation => `<li>${motivation}</li>`).join('') + 
                '</ul>';
        } else {
            purchaseMotivations.innerHTML = strategyData.purchaseMotivations;
        }
    }
    
    // Mettre √† jour les drivers biologiques
    const biologicalDrivers = document.getElementById('biologicalDrivers');
    if (biologicalDrivers && strategyData.biologicalDrivers) {
        if (Array.isArray(strategyData.biologicalDrivers)) {
            biologicalDrivers.innerHTML = '<ul>' + 
                strategyData.biologicalDrivers.map(driver => `<li>${driver}</li>`).join('') + 
                '</ul>';
        } else {
            biologicalDrivers.innerHTML = strategyData.biologicalDrivers;
        }
    }

    // Mettre √† jour les angles marketing cl√©s
    const marketingAngles = document.getElementById('marketingAngles');
    if (marketingAngles && strategyData.marketingAngles) {
        if (Array.isArray(strategyData.marketingAngles)) {
            marketingAngles.innerHTML = '<ul>' + 
                strategyData.marketingAngles.map(angle => `<li>${angle}</li>`).join('') + 
                '</ul>';
        } else {
            marketingAngles.innerHTML = strategyData.marketingAngles;
        }
    }

    // Mettre √† jour les messages marketing √† valeur ajout√©e
    const valueAddedMessages = document.getElementById('valueAddedMessages');
    if (valueAddedMessages && strategyData.valueAddedMessages) {
        if (Array.isArray(strategyData.valueAddedMessages)) {
            valueAddedMessages.innerHTML = '<ul>' + 
                strategyData.valueAddedMessages.map(message => `<li>${message}</li>`).join('') + 
                '</ul>';
        } else {
            valueAddedMessages.innerHTML = strategyData.valueAddedMessages;
        }
    }

    console.log('[Avatar Display] Contenu strat√©gie mis √† jour avec succ√®s');
}

/**
 * Parse le contenu de la strat√©gie marketing et met √† jour les sections sp√©cifiques
 * @param {string} content - Contenu texte de la strat√©gie marketing
 */
function parseAndUpdateStrategySections(content) {
    console.log('[Avatar Display] Parsing du contenu de la strat√©gie marketing');
    console.log('[Avatar Display] Contenu √† parser:', content);
    
    try {
        // Nettoyer le contenu HTML d'abord
        let cleanContent = content;
        if (typeof content === 'string' && content.includes('<div')) {
            // Extraire le contenu textuel du HTML
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = content;
            cleanContent = tempDiv.textContent || tempDiv.innerText || '';
            console.log('[Avatar Display] Contenu nettoy√© du HTML:', cleanContent);
        }
        
        // √âmotions cl√©s √† susciter
        const emotionsMatch = cleanContent.match(/1\.\s*\*\*[^*]*√©motions[^*]*\*\*[^:]*:\s*(.*?)(?=2\.\s*\*\*|$)/si);
        if (emotionsMatch) {
            const emotionsText = emotionsMatch[1].trim();
            console.log('[Avatar Display] √âmotions trouv√©es:', emotionsText);
            const emotions = extractListItems(emotionsText);
            updateSectionContent('keyEmotions', emotions);
        } else {
            console.log('[Avatar Display] Aucune √©motion trouv√©e');
        }
    
    /**
     * Parse le contenu de la strat√©gie marketing et met √† jour les sections sp√©cifiques
     * @param {string} content - Contenu texte de la strat√©gie marketing
     */
    function parseAndUpdateStrategySections(content) {
        console.log('[Avatar Display] Parsing du contenu de la strat√©gie marketing');
        console.log('[Avatar Display] Contenu √† parser:', content);
        
        try {
            // Nettoyer le contenu HTML d'abord
            let cleanContent = content;
            if (typeof content === 'string' && content.includes('<div')) {
                // Extraire le contenu textuel du HTML
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = content;
                cleanContent = tempDiv.textContent || tempDiv.innerText || '';
                console.log('[Avatar Display] Contenu nettoy√© du HTML:', cleanContent);
            }
            
            // √âmotions cl√©s √† susciter
            const emotionsMatch = cleanContent.match(/1\.\s*\*\*[^*]*√©motions[^*]*\*\*[^:]*:\s*(.*?)(?=2\.\s*\*\*|$)/si);
            if (emotionsMatch) {
                const emotionsText = emotionsMatch[1].trim();
                console.log('[Avatar Display] √âmotions trouv√©es:', emotionsText);
            
            if (!altDriversMatch) {
                // Pattern alternatif 2 : chercher "biologiques" suivi de ":"
                altDriversMatch = cleanContent.match(/biologiques[^:]*:\s*(.*?)(?=\d+\.\s*\*\*|angles|$)/si);
            } else {
                console.log('[Avatar Display] Aucune motivation trouv√©e');
            }
            
            // La section "Probl√®mes √† R√©soudre" a √©t√© supprim√©e de l'onglet Strat√©gie
            // car elle est d√©j√† pr√©sente dans l'onglet Analyse Psychologique
            
            console.log('[Avatar Display] === D√âBUT PARSING DRIVERS ===');
            
            // Drivers biologiques majeurs
            const section4Match = cleanContent.match(/4\.\s*\*\*[^*]*\*\*[^:]*:[\s\S]{0,200}/i);
            if (section4Match) {
                console.log('[Avatar Display] Section 4 trouv√©e:', section4Match[0]);
            }
            
            const driversMatch = cleanContent.match(/4\.\s*\*\*Drivers [bB]iologiques(?:\s+(?:Majeurs|principaux))?\*\*[^:]*:\s*(.*?)(?=5\.\s*\*\*|$)/si);
            if (driversMatch) {
                const driversText = driversMatch[1].trim();
                console.log('[Avatar Display] Drivers trouv√©s:', driversText);
                updateSectionContent('biologicalDrivers', driversText);
            } else {
                console.log('[Avatar Display] Aucun driver trouv√© avec le pattern principal');
                
                // Pattern alternatif 1 : chercher "drivers" suivi de ":"
                let altDriversMatch = cleanContent.match(/drivers[^:]*:\s*(.*?)(?=\d+\.\s*\*\*|angles|$)/si);
                
                if (!altDriversMatch) {
                    // Pattern alternatif 2 : chercher "biologiques" suivi de ":"
                    altDriversMatch = cleanContent.match(/biologiques[^:]*:\s*(.*?)(?=\d+\.\s*\*\*|angles|$)/si);
                }
                
                if (!altDriversMatch) {
                    // Pattern alternatif 3 : tr√®s large, chercher tout apr√®s "4."
                    altDriversMatch = cleanContent.match(/4\.\s*[^:]*:\s*(.*?)(?=5\.|angles|$)/si);
                }
                
                if (altDriversMatch) {
                    const driversText = altDriversMatch[1].trim();
                    console.log('[Avatar Display] Drivers trouv√©s (alternative):', driversText);
                    updateSectionContent('biologicalDrivers', driversText);
                } else {
                    console.error('[Avatar Display] Aucun driver trouv√© m√™me avec les patterns alternatifs');
                }
            }
            console.log('[Avatar Display] === FIN PARSING DRIVERS ===');
            
            // Angles marketing cl√©s
            const anglesMatch = cleanContent.match(/5\.\s*\*\*[^*]*angles[^*]*\*\*[^:]*:\s*(.*?)(?=6\.\s*\*\*|$)/si);
            if (anglesMatch) {
                const anglesText = anglesMatch[1].trim();
                console.log('[Avatar Display] Angles trouv√©s:', anglesText);
                const angles = extractListItems(anglesText);
                updateSectionContent('marketingAngles', angles);
            } else {
                console.log('[Avatar Display] Aucun angle trouv√©');
            }
            
            // Messages marketing √† valeur ajout√©e
            const messagesMatch = cleanContent.match(/6\.\s*\*\*[^*]*messages[^*]*\*\*[^:]*:\s*(.*?)(?=En utilisant|En int√©grant|$)/si);
            if (messagesMatch) {
                const messagesText = messagesMatch[1].trim();
                console.log('[Avatar Display] Messages trouv√©s:', messagesText);
                const messages = extractListItems(messagesText);
                updateSectionContent('valueAddedMessages', messages);
            } else {
                console.log('[Avatar Display] Aucun message trouv√©');
            }
            
        } catch (error) {
            console.error('[Avatar Display] Erreur lors du parsing de la strat√©gie:', error);
        }
    }
    
    /**
     * Extrait les √©l√©ments d'une liste depuis un texte
     * @param {string} text - Texte contenant potentiellement une liste
     * @returns {Array} - Tableau des √©l√©ments de la liste
     */
    function extractListItems(text) {
        if (!text) return [];
        
        // Nettoyer le texte
        let cleanText = text.replace(/<[^>]*>/g, '').trim();
        let items = [];
        
        // Rechercher les √©l√©ments avec des tirets
        items = cleanText.match(/-\s*([^-]+?)(?=\s*-|$)/g);
        if (items && items.length > 1) {
            return items.map(item => item.replace(/^-\s*/, '').trim()).filter(item => item.length > 0);
        }
        
        // Rechercher les √©l√©ments num√©rot√©s (1., 2., etc.)
        items = cleanText.match(/\d+\.\s*([^0-9]+?)(?=\s*\d+\.|$)/g);
        if (items && items.length > 1) {
            return items.map(item => item.replace(/^\d+\.\s*/, '').trim()).filter(item => item.length > 0);
        }
        
        // Rechercher les √©l√©ments avec des puces
        items = cleanText.match(/‚Ä¢\s*([^‚Ä¢]+?)(?=\s*‚Ä¢|$)/g);
        if (items && items.length > 1) {
            return items.map(item => item.replace(/^‚Ä¢\s*/, '').trim()).filter(item => item.length > 0);
        }
        
        // Rechercher les phrases s√©par√©es par des points-virgules
        if (cleanText.includes(';')) {
            items = cleanText.split(';').map(item => item.trim()).filter(item => item.length > 0);
            if (items.length > 1) {
                return items;
            }
        }
        
        // Rechercher les phrases s√©par√©es par des virgules (si plus de 2 √©l√©ments)
        if (cleanText.includes(',')) {
            items = cleanText.split(',').map(item => item.trim()).filter(item => item.length > 0);
            if (items.length > 2) {
                return items;
            }
        }
        
        // Rechercher les phrases s√©par√©es par des points (si plus de 2 √©l√©ments)
        if (cleanText.includes('.')) {
            items = cleanText.split('.').map(item => item.trim()).filter(item => item.length > 0);
            if (items.length > 2) {
                return items;
            }
        }
        
        // Si pas de liste d√©tect√©e, retourner le texte tel quel
        return [cleanText];
    }
    
    /**
     * Met √† jour le contenu d'une section sp√©cifique
     * @param {string} sectionId - ID de la section √† mettre √† jour
     * @param {string|Array} content - Contenu √† afficher
     */
    function updateSectionContent(sectionId, content) {
        const element = document.getElementById(sectionId);
        if (!element) return;
        
        if (Array.isArray(content)) {
            element.innerHTML = '<ul>' + 
                content.map(item => `<li>${item}</li>`).join('') + 
                '</ul>';
        } else {
            // Traiter le contenu texte et le convertir en liste si possible
            const processedContent = extractListItems(content);
            if (processedContent.length > 1) {
                element.innerHTML = '<ul>' + 
                    processedContent.map(item => `<li>${item}</li>`).join('') + 
                    '</ul>';
            } else {
                element.innerHTML = content;
            }
        }
        
        console.log(`[Avatar Display] Section ${sectionId} mise √† jour`);
    }
    
    /**
     * Synchronise le contenu de la Synth√®se Strat√©gique avec l'onglet Strat√©gie
     */
    function syncStrategicSynthesis() {
        const strategicSynthesisElement = document.getElementById('strategicSynthesis');
        if (strategicSynthesisElement) {
            const content = strategicSynthesisElement.innerHTML;
            if (content && content.trim() !== '') {
                console.log('[Avatar Display] Synchronisation de la Synth√®se Strat√©gique avec l\'onglet Strat√©gie');
                updateStrategyContent(content);
            }
        }
    }
    
    /**
     * Initialise l'observateur pour la Synth√®se Strat√©gique
     */
    function initStrategicSynthesisObserver() {
        const strategicSynthesisElement = document.getElementById('strategicSynthesis');
        if (!strategicSynthesisElement) {
            console.log('[Avatar Display] √âl√©ment strategicSynthesis non trouv√©, nouvelle tentative dans 1s');
            setTimeout(initStrategicSynthesisObserver, 1000);
            return;
        }
        
        console.log('[Avatar Display] Initialisation de l\'observateur pour la Synth√®se Strat√©gique');
        
        // Cr√©er un observateur de mutations pour d√©tecter les changements
        const observer = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
                if (mutation.type === 'childList' || mutation.type === 'characterData') {
                    console.log('[Avatar Display] Changement d√©tect√© dans la Synth√®se Strat√©gique');
                    setTimeout(() => {
                        syncStrategicSynthesis();
                    }, 100);
                }
            });
        });
        
        // Configurer l'observateur
        observer.observe(strategicSynthesisElement, {
            childList: true,
            subtree: true,
            characterData: true
        });
        
        console.log('[Avatar Display] Observateur de la Synth√®se Strat√©gique initialis√©');
    }
    
    // Fonction pour parser l'analyse psychologique et l'organiser dans les sections appropri√©es
    function parsePsychologicalAnalysis(analysis) {
        console.log('[Avatar Display] Parsing de l\'analyse psychologique:', analysis);
        
        try {
            // Essayer de parser comme JSON d'abord
            const jsonAnalysis = JSON.parse(analysis);
            console.log('[Avatar Display] JSON pars√© avec succ√®s:', jsonAnalysis);
            return jsonAnalysis;
        } catch (e) {
            console.log('[Avatar Display] Pas un JSON valide, traitement comme texte...');
            
            // Fallback : traitement comme texte (ancien comportement)
            let cleanedAnalysis = analysis
                // Supprimer les phrases d'introduction g√©n√©riques
                .replace(/Bien s√ªr,?\s*voici l'analyse demand√©e pour le produit.*?:/gi, '')
                .replace(/Voici l'analyse psychologique.*?:/gi, '')
                .replace(/Analyse psychologique.*?:/gi, '')
                // Supprimer les titres avec ###
                .replace(/###\s*\d+\.\s*\*\*.*?\*\*[^:]*:\s*/gi, '')
                .replace(/###\s*\d+\.\s*.*/gi, '')
                // Supprimer les titres avec **
                .replace(/\*\*Profil psychographique\*\*/gi, '')
                .replace(/\*\*√âmotions cl√©s √† susciter\*\*/gi, '')
                .replace(/\*\*√âmotions √† √©voquer\*\*/gi, '')
                .replace(/\*\*Style de vie\*\*/gi, '')
                .replace(/\*\*Sch√©mas de vie\*\*/gi, '')
                .replace(/\*\*Logique de d√©cision d'achat\*\*/gi, '')
                .replace(/\*\*Logique de d√©cision\*\*/gi, '')
                .replace(/\*\*D√©sir principal\*\*/gi, '')
                .replace(/\*\*Probl√®mes √† r√©soudre\*\*/gi, '')
                .replace(/\*\*Raisons biologiques\*\*/gi, '')
                // Supprimer les num√©rotations au d√©but
                .replace(/^\s*\d+\.\s*/gm, '')
                // Nettoyer les espaces multiples
                .replace(/\s+/g, ' ')
                .trim();
            
            // Diviser par phrases et distribuer
            const sentences = cleanedAnalysis.split(/\.\s+/).filter(s => s.trim().length > 20);
            
            if (sentences.length >= 6) {
                return {
                    mainProfile: sentences.slice(0, 2).join('. ') + '.',
                    emotionsToEvoke: sentences[2] + '.',
                    lifestyleChoices: sentences[3] + '.',
                    decisionLogic: sentences[4] + '.',
                    mainDesire: sentences[5] + '.',
                    problemsToSolve: sentences[6] ? sentences[6] + '.' : 'Informations en cours d\'analyse...',
                    biologicalReasons: sentences[7] ? sentences[7] + '.' : 'Informations en cours d\'analyse...'
                };
            } else {
                // Fallback complet
                return {
                    mainProfile: cleanedAnalysis,
                    emotionsToEvoke: 'Informations en cours d\'analyse...',
                    lifestyleChoices: 'Informations en cours d\'analyse...',
                    decisionLogic: 'Informations en cours d\'analyse...',
                    mainDesire: 'Informations en cours d\'analyse...',
                    problemsToSolve: 'Informations en cours d\'analyse...',
                    biologicalReasons: 'Informations en cours d\'analyse...'
                };
            }
        }
    }
    
    // Fonction pour mettre √† jour une section psychologique sp√©cifique
    function updatePsychologicalSection(sectionId, sectionContent) {
        const sectionElement = document.getElementById(sectionId);
        if (sectionElement && sectionContent) {
            sectionElement.innerHTML = `<p>${sectionContent}</p>`;
        }
    }
    
    // Fonction pour obtenir l'emoji appropri√© pour l'√¢ge
    function getAgeEmoji(age) {
        if (!age || typeof age !== 'string') {
            return "üë§"; // Ic√¥ne par d√©faut (personne)
        }
        
        // G√©rer le cas "X"
        if (age === 'X' || age.toLowerCase().includes('information manquante')) {
            return "‚ùì";
        }
        
        // Extraire le nombre de l'√¢ge (ex: "25 ans" -> 25)
        const ageMatch = age.match(/(\d+)/);
        if (ageMatch) {
            const ageNumber = parseInt(ageMatch[1]);
            if (ageNumber >= 18 && ageNumber <= 25) return 'üë¶';
            if (ageNumber >= 26 && ageNumber <= 35) return 'üë®';
            if (ageNumber >= 36 && ageNumber <= 45) return 'üë®‚Äçüíº';
            if (ageNumber >= 46 && ageNumber <= 55) return 'üßî';
            if (ageNumber >= 56) return 'üë¥';
        }
        
        // Fallback pour les anciens formats de tranches d'√¢ge
        if (age.includes('18-25')) return 'üë¶';
        if (age.includes('26-35')) return 'üë®';
        if (age.includes('36-45') || age.includes('35-45')) return 'üë®‚Äçüíº';
        if (age.includes('46-55')) return 'üßî';
        if (age.includes('56+') || age.includes('55+')) return 'üë¥';
        
        return 'üë§';
    }
    
    // Fonction pour obtenir l'emoji appropri√© pour la situation familiale
    function getFamilyEmoji(familyStatus) {
        if (!familyStatus || typeof familyStatus !== 'string') {
            return "üë•"; // Ic√¥ne par d√©faut (personnes)
        }
        
        if (familyStatus.toLowerCase().includes('c√©libataire')) return "üë§";
        if (familyStatus.toLowerCase().includes('couple') && familyStatus.toLowerCase().includes('enfant')) return "üë®‚Äçüë©‚Äçüëß‚Äçüë¶";
        if (familyStatus.toLowerCase().includes('couple')) return "üë´";
        if (familyStatus.toLowerCase().includes('mari√©') && familyStatus.toLowerCase().includes('enfant')) return "üë®‚Äçüë©‚Äçüëß‚Äçüë¶";
        if (familyStatus.toLowerCase().includes('mari√©')) return "üíë";
        return "üë•";
    }
    
    // Fonction pour obtenir l'ic√¥ne appropri√©e pour une peur
    function getFearIcon(fear) {
        if (!fear || typeof fear !== 'string') {
            return "fa-exclamation-triangle"; // Ic√¥ne par d√©faut
        }
        
        if (fear.includes("co√ªt") || fear.includes("prix") || fear.includes("investissement")) {
            return "fa-coins";
        } else if (fear.includes("difficult√©") || fear.includes("complexe")) {
            return "fa-question-circle";
        } else if (fear.includes("r√©sultat") || fear.includes("efficacit√©")) {
            return "fa-chart-line";
        } else if (fear.includes("fiabilit√©") || fear.includes("durabilit√©")) {
            return "fa-exclamation-circle";
        } else if (fear.includes("service") || fear.includes("support")) {
            return "fa-headset";
        } else {
            return "fa-exclamation-triangle";
        }
    }
    
    // Fonction pour obtenir l'ic√¥ne appropri√©e pour une attente
    function getExpectationIcon(expectation) {
        if (!expectation || typeof expectation !== 'string') {
            return "fa-star"; // Ic√¥ne par d√©faut
        }
        
        if (expectation.includes("temps") || expectation.includes("rapide")) {
            return "fa-tachometer-alt";
        } else if (expectation.includes("r√©sultat") || expectation.includes("professionnel")) {
            return "fa-trophy";
        } else if (expectation.includes("facile") || expectation.includes("simple")) {
            return "fa-tools";
        } else if (expectation.includes("investissement") || expectation.includes("√©conomie")) {
            return "fa-hand-holding-usd";
        } else if (expectation.includes("durable") || expectation.includes("fiable")) {
            return "fa-shield-alt";
        } else {
            return "fa-star";
        }
    }
    
    // Fonction pour initialiser les onglets avatar
    function initializeAvatarTabs() {
        console.log('[Avatar Display] Initialisation des onglets avatar');
        
        const avatarTabs = document.querySelectorAll('.avatar-tab-btn');
        console.log('[Avatar Display] Onglets trouv√©s:', avatarTabs.length);
        
        if (avatarTabs.length === 0) {
            console.error('[Avatar Display] Aucun onglet avatar trouv√©');
            return;
        }
        
        avatarTabs.forEach((tab, index) => {
            console.log(`[Avatar Display] Configuration onglet ${index}:`, tab.getAttribute('data-tab'));
            
            tab.addEventListener('click', () => {
                console.log('[Avatar Display] Clic sur onglet:', tab.getAttribute('data-tab'));
                
                const tabId = tab.getAttribute('data-tab');
                
                // Retirer la classe active de tous les onglets
                const allTabs = document.querySelectorAll('.avatar-tab-btn');
                allTabs.forEach(t => t.classList.remove('active'));
                
                // Ajouter la classe active √† l'onglet cliqu√©
                tab.classList.add('active');
                
                // Retirer la classe active de tous les contenus d'onglets
                const allTabPanes = document.querySelectorAll('.avatar-tab-pane');
                allTabPanes.forEach(pane => pane.classList.remove('active'));
                
                // Afficher le contenu de l'onglet s√©lectionn√©
                const tabContent = document.querySelector(`#${tabId}`);
                if (tabContent) {
                    tabContent.classList.add('active');
                    console.log('[Avatar Display] Onglet activ√©:', tabId);
                } else {
                    console.error('[Avatar Display] Contenu d\'onglet non trouv√©:', tabId);
                }
            });
        });
        
        console.log('[Avatar Display] Onglets avatar initialis√©s avec succ√®s');
    }
    
    // API publique
    return {
        createAvatarSection: createAvatarSection,
        updateAvatarProfile: updateAvatarProfile,
        updateStrategyContent: updateStrategyContent,
        syncStrategicSynthesis: syncStrategicSynthesis,
        initStrategicSynthesisObserver: initStrategicSynthesisObserver
    };
})();

// Exposer le module globalement
window.avatarDisplay = avatarDisplay;

// Initialisation de l'observateur pour la Synth√®se Strat√©gique
window.avatarDisplay.initStrategicSynthesisObserver();
